#!/bin/bash
##
## Batocera.PLUS
##
set -e

################################################################################

# Batocera.PLUS Version 
VERSION='2.17'

# Remova esta linha para diminuir o tempo de compilação.
# A imagem não será compactada e nem gerado o md5sum.
# Serão dicionados pacotes experimentais.
RELEASE='alpha'

# Squashfs compression level
SQUASHFS_COMPRESSION='2'

# Add all bios to image
ALL_BIOS=true

# Temporary folder on a linux partition
TEMP_DIR='./output'
#TEMP_DIR='/media/Linux/tmp'

# BatoceraZero image
BATOCERA_ZERO='BatoceraZero3.7GB-1.7z' # image size: 3655701504
#BATOCERA_ZERO='BatoceraZero4GB-1.7z'  # image size: 4G
#BATOCERA_ZERO='BatoceraZero5GB-1.7z'  # image size: 5G
#BATOCERA_ZERO='BatoceraZero6GB-1.7z'  # image size: 6G
#BATOCERA_ZERO='BatoceraZero7GB-1.7z'  # image size: 7G

# Batocera.PLUS extra files
PLUS_DIR='plus'
UPDATE_DIR='update'
BOOT_DIR='boot'
DOWNLOAD_DIR='download'
PATCH_DIR='patch'

################################################################################

# DOWNLOADS LINKS

URL_BATOCERA_PLUS_PKG=(
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/proton-valve-6.3-7-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/proton-ge-custom-6.18-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wine-old-stable-5.0.5-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wine-stable-6.0.1-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wine-staging-6.18-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wine-lutris-6.14-3-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wine-extra-libs-8.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/DX9Jun2010.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/msttcorefonts-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dxvk-1.5.1-3.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dxvk-proton-ge-custom-6.18-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wine_mf-1.0.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-1.9.9-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-assets-1.9.9-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-cheats-1.9.7-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-info-1.9.10-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-retroachievements-sounds-1.9.7-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-slang-shaders-1.9.9-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-glsl-shaders-1.9.9-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-common-shaders-1.9.7-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-batocera-shaders-1.9.7-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retroarch-batocera-plus-shaders-1.9.7-1.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/4do_libretro-feb-3-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/81_libretro-feb-4-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/atari800_libretro-feb-7-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/beetle-saturn_libretro-set-18-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/blastem_libretro-mar-09-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/bluemsx_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/bsnes_hd_libretro-jun-18-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/bsnes_libretro-aug-1-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/cap32_libretro-mar-3-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/catsfc_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/citra_libretro-jul-30-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/crocods_libretro-jan-7-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/desmume_libretro-jan-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dolphin_libretro-feb-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dosbox_libretro-jan-26-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dosbox_pure_libretro-feb-23-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/duckstation_libretro-aug-1-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/emuscv_libretro-mar-4-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fbalpha2012_libretro-feb-21-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fbalpha2012_cps1_libretro-jan-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fbalpha2012_cps2_libretro-jan-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fbalpha2012_cps3_libretro-Jan-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fbalpha2012_neogeo_libretro-jan-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fbneo_libretro-mar-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fceumm_libretro-mar-8-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/flycast2019_libretro-aug-13-2019-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/flycast_libretro-may-17-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fmsx_libretro-mar-3-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/freechaf_libretro-jan-2-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/freej2me_libretro-may-22-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/freeintv_libretro-jul-30-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/fuse_libretro-feb-4-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/gambatte_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/gearsystem_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/genesisplusgx_libretro-set-18-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/genesisplusgx_wide_libretro-set-25-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/gpsp_libretro-mar-7-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/gw_libretro-jan-29-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/handy_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/hatari_libretro-oct-27-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/hbmame_libretro-apr-3-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/ishiiruka_libretro-oct-3-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/kronos_libretro-jul-28-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/lutro_libretro-mar-2-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame_libretro-feb-24-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame0200_libretro-nov-8-2018-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame0160_libretro-dec-21-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame0174_libretro-jun-22-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame0139_libretro-mar-7-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame078plus_libretro-mar-7-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mame037_libretro-feb-21-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mednafen_lynx_libretro-jan-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mednafen_ngp_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mednafen_psx_libretro-feb-28-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mednafen_psx_sw_libretro-feb-28-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mednafen_supergrafx_libretro-apr-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mednafen_wswan_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/melonds_libretro-apr-11-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mesen_libretro-jun-30-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mesen-s_libretro-jul-8-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/meteor_libretro-dec-28-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mgba_libretro-jul-12-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mrboom_libretro-feb-12-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mu_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mupen64plus-next_libretro-Feb-26-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/nekop2_libretro-jan-10-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/neocd-libretro-apr-25-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/nestopia_libretro-mar-5-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/np2kai_libretro-feb-11-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/nxengine_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/o2em_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/opera_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/parallel_n64_libretro-jan-27-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pce_fast_libretro-apr-8-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pce_libretro-apr-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pcfx_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pcsx_rearmed_libretro-jul-31-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pcsx2_libretro-set-22-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/picodrive_libretro-apr-10-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pokemini_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/potator_libretro-aug-5-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/ppsspp_libretro-mar-2-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/prboom_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/prosystem_libretro-mar-3-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/puae_libretro-mar-4-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/px68k_libretro-jan-13-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/quasi88_libretro-mar-7-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/quicknes_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/race_libretro-aug-2-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/redream_libretro-jun-7-2020-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/retro8_libretro-jan-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/scummvm_libretro-mar-5-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/smsplus_libretro-jan-24-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/snes9x_libretro-may-27-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/snes9x_next_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/stella_libretro-mar-2-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/tgbdual_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/theodore_libretro-jan-31-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/tic80_libretro-mar-5-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/tyrquake_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/uzem_libretro-jan-8-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/vba-m_libretro-feb-27-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/vb_libretro-feb-25-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/vecx_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/vice_libretro-mar-9-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/virtualjaguar_libretro-feb-14-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/x1_libretro-jan-8-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/yabasanshiro_libretro-feb-4-2021-2.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/yabause_libretro-set-22-2021-1.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dolphin-emu-5.0-13603-feb-3-2021-2.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/freej2me-may-22-2021-2.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/hypseus-singe-apr-17-2021-1.7z' # remove on update.
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/ppsspp-mar-2-2021-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/rpcs3-0.0.15-3.7z' # remove on update.
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/xemu-sep-27-2021-1.7z' # remove on update.
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/xemu-libs-(libgtk-3_libgdk_libaio)-1.7z' # dep: xemu # remove on update.

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/cemuextras-1.3.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/cemufakefiles-1.0.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/Future_Pinball-1.3.7z' # remove on update.
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/model2-1.1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/model3-1.1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/Visual_Pinball-1.0.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/vpinball_fonts-1.0.7z' # dep: visual pinball
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/rpcs3_extra_libs-1.1.7z' # dep: rpcs3
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/ryujinx_extras-1.1.7z' # dep: ryujinx

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/bzip2-1.0.8.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/unrar-5.90-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/zstd-1.4.3-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/libcap-2.27-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/squashfs-tools-4.4-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/popstationr-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/git-2.31.1-1.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/imagemagic-7.0.8-59-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/xmlstarlet-1.6.1-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/dos2unix-7.4.1-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/util-linux-extras-2.35-1.7z' # cfdisk, swapon, whereis
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/preload-0.6.4-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/GOverlay-libs.7z' # dep: goverlay
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/vkBasalt-0.3.2.3-4.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/parsec-2.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/tint2-16.7-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/jgmenu-4.2.1-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/imlib2-1.5.1-1.7z'    # dep: tint2
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/librsvg-2.40.20-1.7z' # dep: tint2, jgmenu
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/libcroco-0.6-1.7z'    # dep: tint2, jgmenu
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/adwaita-blue-light-167841-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/flash-player-32.0.0.465-(FlashPatch-1.5)-1.7z' # dep: firefox

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/user-manual-2.7z'

    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/wii-u-gc-adapter-mar-6-2021-3.7z' # remove on update
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/xow-apr-8-2021-1.7z'              # remove on update
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/xdriver_xf86-video-intel-1.7z'    # remove on update
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/nvidia-driver-470.74-1.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/nvidia-driver-390.143-2.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/nvidia-driver-340.108-2.7z'
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mesa3d-64bits-21.1.6-1.7z'        # remove on update
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/mesa3d-32bits-21.1.6-1.7z'        # remove on update
    'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/pipewire-0.3.31-1.7z'             # remove on update
)

# Estes pacotes são compilados apenas nas imagens de desenvolvimento.
if [ -z "${RELEASE}" ]; then
    URL_BATOCERA_PLUS_PKG=("${URL_BATOCERA_PLUS_PKG[@]}"
        'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/play_libretro-mar-8-2021-1.7z'
        'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/obs-studio-27.0.1-1.7z'
        'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/obs-studio-extra-libs-1.7z' #dep: obs-studio
        'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/xdotool-aug-4-2021.7z'
    )
fi

URL_BATOCERA_LINUX='https://batocera.org/upgrades/x86_64/stable/last/archives/20201001/batocera-5.27.2-x86_64-20201001.img.gz'

URL_BATOCERA_ZERO="https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/${BATOCERA_ZERO}"

URL_PCI_IDS='http://pci-ids.ucw.cz/v2.2/pci.ids.gz'
URL_NVIDIA_DRIVER='http://download.nvidia.com/XFree86/Linux-x86_64/470.74/NVIDIA-Linux-x86_64-470.74.run'

URL_ES_THEME_A='0611dda9ffcfcfe8d8c17bdda2a19021c0ac6c40'
URL_ES_THEME_A="https://github.com/AlexxandreFS/Batocera.PLUS-es-theme/archive/${URL_ES_THEME_A}.zip#/Batocera.PLUS-es-theme-${URL_ES_THEME_A}.zip"

URL_MUSIC='2920d01d9953d9b2c9b183d980fd688f1c1d77b2'
URL_MUSIC="https://github.com/BatoceraPLUS/Batocera.PLUS-music/archive/${URL_MUSIC}.zip#/Batocera.PLUS-music-${URL_MUSIC}.zip"

URL_ALL_BIOS='638531398486ca8c36b9f16f88b36dc1b4087a5e'
URL_ALL_BIOS="https://github.com/BatoceraPLUS/Batocera.PLUS-bios/archive/${URL_ALL_BIOS}.zip#/Batocera.PLUS-bios-${URL_ALL_BIOS}.zip"

URL_WINDOWS_TOOLS='e5f2a8c02390a6fe78106c84960cb6d2326ddfda'
URL_WINDOWS_TOOLS="https://github.com/AlexxandreFS/Batocera.PLUS-tools/archive/${URL_WINDOWS_TOOLS}.zip#/Batocera.PLUS-tools-${URL_WINDOWS_TOOLS}.zip"

URL_JAVA="$(wget -S --spider --max-redirect 0 'https://javadl.oracle.com/webapps/download/AutoDL?BundleId=244575_d7fc238d0cbf4b0dac67be84580cfb4b' 2>&1 | grep -E '^  Location: ' | cut -d ' ' -f 4)"
URL_JAVA="${URL_JAVA}#/$(echo ${URL_JAVA} | sed 's/File=/;/' | cut -d ';' -f 2 | cut -d '&' -f 1)"

URL_WINE_MONO='https://dl.winehq.org/wine/wine-mono/6.4.0/wine-mono-6.4.0-x86.tar.xz'
URL_WINE_DXVK='https://github.com/doitsujin/dxvk/releases/download/v1.9.2/dxvk-1.9.2.tar.gz'
URL_WINE_VKD3D_PROTON='https://github.com/HansKristian-Work/vkd3d-proton/releases/download/v2.4/vkd3d-proton-2.4.tar.zst'
URL_WINE_NVAPI='https://github.com/jp7677/dxvk-nvapi/releases/download/v0.4/dxvk-nvapi-v0.4.tar.gz'

URL_CEMU="$(curl -s http://cemu.info | grep -i 'cemu_.*' | tail -n 1 | cut -d '"' -f 2 | cut -d ' ' -f 1)"
URL_CEMUHOOK="$(curl -s https://cemuhook.sshnuke.net/ | grep -A 2 -F '<h2>Current versions</h2>' | grep '.zip' | cut -d '"' -f 2)"

URL_YUZU_MAINLINE='https://github.com/yuzu-emu/yuzu-mainline/releases/download/mainline-0-753/yuzu-20210918-1b2e2d4d0.AppImage'
URL_YUZU_EARLY_ACCESS='https://github.com/pineappleEA/pineapple-src/releases/download/EA-2071/Yuzu-EA-2071.AppImage'

URL_RYUJINX='https://ci.appveyor.com/api/buildjobs/tjpbl945yxq8rtr0/artifacts/ryujinx-1.0.7047-linux_x64.tar.gz'

URL_RPCS3='https://github.com/RPCS3/rpcs3-binaries-linux/releases/download/build-e307a1b4bda48fb8f3f99bf37455fcbab321a214/rpcs3-v0.0.18-12794-e307a1b4_linux64.AppImage'

URL_GOVERLAY='https://github.com/benjamimgois/goverlay/releases/download/0.6.1/goverlay_0_6_1.tar.xz'
URL_MANGOHUD='https://github.com/flightlessmango/MangoHud/releases/download/v0.6.5/MangoHud-0.6.5.r0.ge42002c.tar.gz'

URL_ANTIMICRO='3.1.7'
URL_ANTIMICRO="https://github.com/AntiMicroX/antimicrox/releases/download/${URL_ANTIMICRO}/AntiMicroX-x86_64.AppImage#/AntiMicroX-${URL_ANTIMICRO}.AppImage"

URL_FIREFOX="$(wget -S --spider --max-redirect 0 'https://download.mozilla.org/?product=firefox-esr-latest&os=linux64&lang=en-US' 2>&1 | grep 'esr.tar.bz2$' | cut -d ' ' -f 4)"

URL_QBITTORRENT='https://github.com/c0re100/qBittorrent-Enhanced-Edition/releases/download/release-4.3.7.10/qBittorrent-Enhanced-Edition.AppImage'
URL_QBITTORRENT=$(echo ${URL_QBITTORRENT}#/$(basename ${URL_QBITTORRENT} | sed "s/.AppImage/-$(basename $(dirname ${URL_QBITTORRENT}) | cut -d '-' -f 2).AppImage/"))

################################################################################

# DOWNLOAD

mkdir -p "${DOWNLOAD_DIR}"

for URL in "${URL_BATOCERA_PLUS_PKG[@]}" \
           "${URL_BATOCERA_LINUX}" \
           "${URL_BATOCERA_ZERO}" \
           "${URL_ES_THEME_A}" \
           "${URL_ALL_BIOS}" \
           "${URL_MUSIC}" \
           "${URL_WINDOWS_TOOLS}" \
           "${URL_PCI_IDS}" \
           "${URL_NVIDIA_DRIVER}" \
           "${URL_JAVA}" \
           "${URL_WINE_MONO}" \
           "${URL_WINE_DXVK}" \
           "${URL_WINE_VKD3D_PROTON}" \
           "${URL_WINE_NVAPI}" \
           "${URL_CEMU}" \
           "${URL_CEMUHOOK}" \
           "${URL_YUZU_MAINLINE}" \
           "${URL_YUZU_EARLY_ACCESS}" \
           "${URL_RYUJINX}" \
           "${URL_GOVERLAY}" \
           "${URL_MANGOHUD}" \
           "${URL_ANTIMICRO}" \
           "${URL_RPCS3}" \
           "${URL_FIREFOX}" \
           "${URL_QBITTORRENT}"
do
    PKG_NAME="$(basename "${URL}")"
    echo -e "\nBaixando ${PKG_NAME}..."

    if ! [ -f "${DOWNLOAD_DIR}/${PKG_NAME}" ]; then
        curl -L -C - "${URL}" -o "${DOWNLOAD_DIR}/${PKG_NAME}" || exit $?
    fi
done

################################################################################

echo -e '\nDescompactando Batocera.Linux...'
PKG_NAME="$(basename "${URL_BATOCERA_LINUX}")"
mkdir -p "${TEMP_DIR}"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c > "${TEMP_DIR}/batocera.linux.img"

echo 'Adicionando imagem oficial do batocera.linux ao disposivo loop...'
losetup -f
losetup /dev/loop7 -o $((512 * 2048)) "${TEMP_DIR}/batocera.linux.img"

echo 'Montando imagem do batocera.linux...'
mkdir "${TEMP_DIR}/BATOCERA"
mount -o rw /dev/loop7 "${TEMP_DIR}/BATOCERA"

echo 'Descompactando arquivo squashfs...'
unsquashfs -d "${TEMP_DIR}/squashfs-root" "$TEMP_DIR/BATOCERA/boot/batocera"

################################################################################

echo 'Removendo arquivos desnecessários...'

# Remova apenas se atualizar o pacote completo dos shaders para o retroarch.
rm -r "$TEMP_DIR/squashfs-root/usr/share/batocera/shaders"

# Remove icones duplicados e fora do padrão para um próximo update.
rm -r "$TEMP_DIR/squashfs-root/usr/share/applications/scummvm.desktop"
rm -r "$TEMP_DIR/squashfs-root/usr/share/applications/dolphin-emu.desktop"
rm -r "$TEMP_DIR/squashfs-root/usr/share/applications/retroarch.desktop"
rm -r "$TEMP_DIR/squashfs-root/usr/share/applications/pcmanfm-desktop-pref.desktop"

# Remove roms que por padrão já vem com o sistema
for x in c64 gba megadrive nes pcengine prboom snes; do
    for y in "$TEMP_DIR/squashfs-root/usr/share/batocera/datainit/roms/${x}/"*; do
        if [ "${y}" != "$TEMP_DIR/squashfs-root/usr/share/batocera/datainit/roms/${x}/_info.txt" ]; then
            rm -r "${y}" || exit $?
        fi
    done
done

# Desativa por padrão o jogo MrBoom
mv $TEMP_DIR/squashfs-root/usr/share/batocera/datainit/roms/mrboom/MrBoom.libretro \
   $TEMP_DIR/squashfs-root/usr/share/batocera/datainit/roms/mrboom/MrBoom.libretro.disable \

# Remove o driver antigo do Nvidia
KERNEL_VERSION="$(ls ${TEMP_DIR}/squashfs-root/lib/modules)"
NVIDIA_VERSION="$(modinfo "${TEMP_DIR}/squashfs-root/lib/modules/${KERNEL_VERSION}/extra/nvidia.ko" | grep -E '^version: ' | awk '{print $2}')"

NVIDIA_FILES=(
    /lib/modules/${KERNEL_VERSION}/extra/nvidia-drm.ko
    /lib/modules/${KERNEL_VERSION}/extra/nvidia-modeset.ko
    /lib/modules/${KERNEL_VERSION}/extra/nvidia-uvm.ko
    /lib/modules/${KERNEL_VERSION}/extra/nvidia.ko
    /lib32/libEGL_nvidia.so
    /lib32/libEGL_nvidia.so.0
    /lib32/libEGL_nvidia.so.${NVIDIA_VERSION}
    /lib32/libGLESv1_CM_nvidia.so
    /lib32/libGLESv1_CM_nvidia.so.1
    /lib32/libGLESv1_CM_nvidia.so.${NVIDIA_VERSION}
    /lib32/libGLESv2_nvidia.so
    /lib32/libGLESv2_nvidia.so.2
    /lib32/libGLESv2_nvidia.so.${NVIDIA_VERSION}
    /lib32/libGLX_nvidia.so
    /lib32/libGLX_nvidia.so.0
    /lib32/libGLX_nvidia.so.${NVIDIA_VERSION}
    /lib32/libnvidia-eglcore.so
    /lib32/libnvidia-eglcore.so.${NVIDIA_VERSION}
    /lib32/libnvidia-glcore.so
    /lib32/libnvidia-glcore.so.${NVIDIA_VERSION}
    /lib32/libnvidia-glsi.so
    /lib32/libnvidia-glsi.so.${NVIDIA_VERSION}
    /lib32/libnvidia-ml.so
    /lib32/libnvidia-ml.so.1
    /lib32/libnvidia-ml.so.${NVIDIA_VERSION}
    /lib32/libnvidia-tls.so
    /lib32/libnvidia-tls.so.${NVIDIA_VERSION}
    /lib32/libvdpau_nvidia.so
    /lib32/libvdpau_nvidia.so.1
    /lib32/libvdpau_nvidia.so.${NVIDIA_VERSION}
    /usr/lib/libEGL_nvidia.so
    /usr/lib/libEGL_nvidia.so.0
    /usr/lib/libEGL_nvidia.so.${NVIDIA_VERSION}
    /usr/lib/libGLESv1_CM_nvidia.so
    /usr/lib/libGLESv1_CM_nvidia.so.1
    /usr/lib/libGLESv1_CM_nvidia.so.${NVIDIA_VERSION}
    /usr/lib/libGLESv2_nvidia.so
    /usr/lib/libGLESv2_nvidia.so.2
    /usr/lib/libGLESv2_nvidia.so.${NVIDIA_VERSION}
    /usr/lib/libGLX_nvidia.so
    /usr/lib/libGLX_nvidia.so.0
    /usr/lib/libGLX_nvidia.so.${NVIDIA_VERSION}
    /usr/lib/libnvidia-eglcore.so
    /usr/lib/libnvidia-eglcore.so.${NVIDIA_VERSION}
    /usr/lib/libnvidia-glcore.so
    /usr/lib/libnvidia-glcore.so.${NVIDIA_VERSION}
    /usr/lib/libnvidia-glsi.so
    /usr/lib/libnvidia-glsi.so.${NVIDIA_VERSION}
    /usr/lib/libnvidia-ml.so
    /usr/lib/libnvidia-ml.so.1
    /usr/lib/libnvidia-ml.so.${NVIDIA_VERSION}
    /usr/lib/libnvidia-tls.so
    /usr/lib/libnvidia-tls.so.${NVIDIA_VERSION}
    /usr/lib/libvdpau_nvidia.so
    /usr/lib/libvdpau_nvidia.so.1
    /usr/lib/libvdpau_nvidia.so.${NVIDIA_VERSION}
    /usr/lib/xorg/modules/drivers/nvidia_drv.so
    /usr/share/glvnd/egl_vendor.d/10_nvidia.json
    /usr/share/X11/xorg.conf.d/10-nvidia-drm-outputclass.conf
    /usr/lib/libnvidia-egl-wayland.so
    /usr/lib/libnvidia-egl-wayland.so.1
    /usr/lib/libnvidia-egl-wayland.so.1.1.4
    /usr/lib/xorg/modules/extensions/libglxserver_nvidia.so
    /usr/lib/xorg/modules/extensions/libglxserver_nvidia.so.1
    /usr/lib/xorg/modules/extensions/libglxserver_nvidia.so.${NVIDIA_VERSION}
    #/usr/share/vulkan/implicit_layer.d/nvidia_layers.json
    #/usr/share/vulkan/icd.d/nvidia_icd.i686.json
    #/usr/share/vulkan/icd.d/nvidia_icd.x86_64.json
    #/lib32/libnvidia-glvkspirv.so
    #/lib32/libnvidia-glvkspirv.so.${NVIDIA_VERSION}
    #/usr/lib/libnvidia-glvkspirv.so
    #/usr/lib/libnvidia-glvkspirv.so.${NVIDIA_VERSION}
)

for FILE in ${NVIDIA_FILES[@]}
do
    if [ -e "${TEMP_DIR}/squashfs-root${FILE}" ]
    then
        rm "${TEMP_DIR}/squashfs-root${FILE}" || exit $?
    else
        echo "not found: ${TEMP_DIR}/squashfs-root${FILE}"
        exit 1
    fi
done

################################################################################

echo 'Desativando servicos...'
mv    "$TEMP_DIR/squashfs-root/etc/init.d/S49ntp"          "$TEMP_DIR/squashfs-root/etc/init.d/K49ntp"
mv    "$TEMP_DIR/squashfs-root/etc/init.d/S50triggerhappy" "$TEMP_DIR/squashfs-root/etc/init.d/K50triggerhappy"

################################################################################

echo 'Copiando arquivos do batocera.plus...'
cp -r -f "$PLUS_DIR/"*   "$TEMP_DIR/squashfs-root"
cp -r -f "$UPDATE_DIR/"* "$TEMP_DIR/squashfs-root"

################################################################################

### CREATE RAM DISK

echo 'criando disco ram...'

mkdir -p "${TEMP_DIR}/pkg-xtract"
mount -t tmpfs -o size=1536M tmpfs "${TEMP_DIR}/pkg-xtract"

################################################################################

### INSTALL PKGs

echo 'Install PKGs...'

for PKG in "${URL_BATOCERA_PLUS_PKG[@]}"; do
    echo -e "\nInstall ${PKG_NAME%.*}..."
    PKG_NAME="$(basename "${PKG}")"

    7zr x  "${DOWNLOAD_DIR}/${PKG_NAME}" -o"${TEMP_DIR}/pkg-xtract" || exit $?

    # Executa o script batocera.plus que fica dentro do pacote.
    # O script contém instruções expecíficas de instação para o pacote.
    if [ -f "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/batocera.plus" ]; then
        source "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/batocera.plus" || exit $?
        rm -f  "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/batocera.plus" || exit $?
    fi

    cp -rf "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/"* "${TEMP_DIR}/squashfs-root" || exit $?
    rm -r "${TEMP_DIR}/pkg-xtract/"*
done

################################################################################

echo 'Install batocera.plus theme...'
PKG_NAME="$(basename "${URL_ES_THEME_A}")"
unzip "${DOWNLOAD_DIR}/${PKG_NAME}" -d "${TEMP_DIR}/pkg-xtract"
cp -rf "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}" \
       "${TEMP_DIR}/squashfs-root/usr/share/emulationstation/themes/batocera-plus"
rm -r  "${TEMP_DIR}/pkg-xtract/"*

if [ "${ALL_BIOS}" == 'true' ]; then
    echo 'Install All Bios...'
    PKG_NAME="$(basename "${URL_ALL_BIOS}")"
    busybox unzip "${DOWNLOAD_DIR}/${PKG_NAME}" -d "${TEMP_DIR}/pkg-xtract" || exit $?
    rm -rf "${TEMP_DIR}/squashfs-root/usr/share/batocera/datainit/bios/"*
    cp -rf "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/"* \
           "${TEMP_DIR}/squashfs-root/usr/share/batocera/datainit/bios" || exit $?
    rm -r "${TEMP_DIR}/pkg-xtract/"*
fi

echo 'Install Music...'
PKG_NAME="$(basename "${URL_MUSIC}")"
unzip "${DOWNLOAD_DIR}/${PKG_NAME}" -d "${TEMP_DIR}/pkg-xtract" || exit $?
rm -rf "${TEMP_DIR}/squashfs-root/usr/share/batocera/music/"*
cp -rf "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/"* \
       "${TEMP_DIR}/squashfs-root/usr/share/batocera/music" || exit $?
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install Wine-Extra Libs...'
# Remova a linha à baixo (mv) em uma futura atualização.
mv "${TEMP_DIR}/squashfs-root/opt/Wine/linux" "${TEMP_DIR}"

echo 'Install Wine Mono...'
PKG_NAME="$(basename "${URL_WINE_MONO}")"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Wine/apps"
xz -d -k -c -v "${DOWNLOAD_DIR}/${PKG_NAME}" | tar xv -C "${TEMP_DIR}/squashfs-root/opt/Wine/apps"
mv "${TEMP_DIR}/squashfs-root/opt/Wine/apps/wine-mono-"* \
   "${TEMP_DIR}/squashfs-root/opt/Wine/apps/mono"

echo 'Install Wine DXVK...'
PKG_NAME="$(basename "${URL_WINE_DXVK}")"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Wine/apps"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c | tar x -v -C "${TEMP_DIR}/pkg-xtract"
cp -r "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.tar.gz}" "${TEMP_DIR}/squashfs-root/opt/Wine/apps/dxvk"
ln -s '/opt/Wine/apps/vkd3d-proton/x32/d3d12.dll'  "${TEMP_DIR}/squashfs-root/opt/Wine/apps/dxvk/x32/d3d12.dll"
ln -s '/opt/Wine/apps/vkd3d-proton/x64/d3d12.dll'  "${TEMP_DIR}/squashfs-root/opt/Wine/apps/dxvk/x64/d3d12.dll"
ln -s '/opt/Wine/apps/nvapi/x32/nvapi.dll'         "${TEMP_DIR}/squashfs-root/opt/Wine/apps/dxvk/x32/nvapi.dll"
ln -s '/opt/Wine/apps/nvapi/x64/nvapi64.dll'       "${TEMP_DIR}/squashfs-root/opt/Wine/apps/dxvk/x64/nvapi64.dll"
rm "${TEMP_DIR}/squashfs-root/opt/Wine/apps/dxvk/setup_dxvk.sh"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install Wine VKD3D_PROTON (DXVK12)...'
PKG_NAME="$(basename "${URL_WINE_VKD3D_PROTON}")"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Wine/apps/vkd3d-proton/x32"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Wine/apps/vkd3d-proton/x64"
if ! [ -f /usr/bin/zstd ]; then
    # Este bloco if foi adicionado para não quebrar a compilação do batocera.plus em versões mais antigas (batocera.plus 2.0)
    # Remova este bloco if quando sair a pŕoxima imagem stable.
    "${TEMP_DIR}/squashfs-root/usr/bin/zstd" -d -c "${DOWNLOAD_DIR}/${PKG_NAME}" | tar -xvC "${TEMP_DIR}/pkg-xtract" || exit $?
else
    # Não remova esta linha quando remover o bloco if.
    zstd -d -c "${DOWNLOAD_DIR}/${PKG_NAME}" | tar -xvC "${TEMP_DIR}/pkg-xtract" || exit $?
fi
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.tar.zst}/x86/d3d12.dll" "${TEMP_DIR}/squashfs-root/opt/Wine/apps/vkd3d-proton/x32"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.tar.zst}/x64/d3d12.dll" "${TEMP_DIR}/squashfs-root/opt/Wine/apps/vkd3d-proton/x64"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install Wine Nvidia NVAPI...'
PKG_NAME="$(basename "${URL_WINE_NVAPI}")"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Wine/apps/nvapi"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c | tar x -v -C "${TEMP_DIR}/pkg-xtract"
rm "${TEMP_DIR}/pkg-xtract/README.md"
rm "${TEMP_DIR}/pkg-xtract/LICENSE"
cp -r "${TEMP_DIR}/pkg-xtract/"* "${TEMP_DIR}/squashfs-root/opt/Wine/apps/nvapi"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install GOverlay...'
PKG_NAME="$(basename "${URL_GOVERLAY}")"
xz -d -k -c -v "${DOWNLOAD_DIR}/${PKG_NAME}" | tar xv -C "${TEMP_DIR}/squashfs-root/opt/GOverlay/bin"

echo 'Install MangoHud...'
PKG_NAME="$(basename "${URL_MANGOHUD}")"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c | tar x -v -C "${TEMP_DIR}/pkg-xtract"
tar -xvf "${TEMP_DIR}/pkg-xtract/MangoHud/MangoHud-package.tar" -C "${TEMP_DIR}/pkg-xtract/MangoHud"
mv "${TEMP_DIR}/pkg-xtract/MangoHud/usr/lib/mangohud/lib" "${TEMP_DIR}/squashfs-root/opt/MangoHud/lib64"
mv "${TEMP_DIR}/pkg-xtract/MangoHud/usr/lib/mangohud/lib32" "${TEMP_DIR}/squashfs-root/opt/MangoHud/lib"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install AntiMicroX...'
PKG_NAME="$(basename "${URL_ANTIMICRO}")"
chmod +x "${DOWNLOAD_DIR}/${PKG_NAME}"
mkdir -p "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
CURRENT_DIR="$(pwd)"
cd "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
"${CURRENT_DIR}/${DOWNLOAD_DIR}/${PKG_NAME}" --appimage-extract
cd "${CURRENT_DIR}"
unset CURRENT_DIR
mkdir -p "${TEMP_DIR}/squashfs-root/opt/AntiMicroX"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/bin/antimicrox" "${TEMP_DIR}/squashfs-root/opt/AntiMicroX"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install Firefox...'
PKG_NAME="$(basename "${URL_FIREFOX}")"
bunzip2 -d -k -v -c "${DOWNLOAD_DIR}/${PKG_NAME}" | tar x -v -C "${TEMP_DIR}/squashfs-root/opt/Firefox"
mv    "${TEMP_DIR}/squashfs-root/opt/Firefox/firefox/"* \
      "${TEMP_DIR}/squashfs-root/opt/Firefox/firefox-esr"
rmdir "${TEMP_DIR}/squashfs-root/opt/Firefox/firefox"

echo 'Install qBittorrent...'
PKG_NAME="$(basename "${URL_QBITTORRENT}")"
cp "${DOWNLOAD_DIR}/${PKG_NAME}" "${TEMP_DIR}/squashfs-root/opt/qBittorrent/qBittorrent-Enhanced-Edition.AppImage"
chmod +x "${TEMP_DIR}/squashfs-root/opt/qBittorrent/qBittorrent-Enhanced-Edition.AppImage"

echo 'Install Java...'
PKG_NAME="$(basename "${URL_JAVA}")"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c | tar x -v -C "${TEMP_DIR}/squashfs-root/opt"
mv "${TEMP_DIR}/squashfs-root/opt/jre"*  "${TEMP_DIR}/squashfs-root/opt/Java"

echo 'Install Cemu...'
PKG_NAME="$(basename "${URL_CEMU%.*}")"
unzip "${DOWNLOAD_DIR}/${PKG_NAME}" -d "${TEMP_DIR}/squashfs-root/opt"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Cemu/emulator"
rm -r "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}/graphicPacks"
mv    "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}/"* "${TEMP_DIR}/squashfs-root/opt/Cemu/emulator"
rm -r "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}"

echo 'Install CemuHook...'
PKG_NAME="$(basename "${URL_CEMUHOOK%.*}")"
unzip "${DOWNLOAD_DIR}/${PKG_NAME}" -d "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}"
mkdir -p  "${TEMP_DIR}/squashfs-root/opt/Cemu/cemuhook"
rm -r "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}/Go to project website for updates.url"
mv "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}/"* "${TEMP_DIR}/squashfs-root/opt/Cemu/cemuhook"
rmdir "${TEMP_DIR}/squashfs-root/opt/${PKG_NAME}"

echo 'Install Yuzu Mainline...'
PKG_NAME="$(basename "${URL_YUZU_MAINLINE}")"
chmod +x "${DOWNLOAD_DIR}/${PKG_NAME}"
mkdir -p "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
CURRENT_DIR="$(pwd)"
cd "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
"${CURRENT_DIR}/${DOWNLOAD_DIR}/${PKG_NAME}" --appimage-extract
cd "${CURRENT_DIR}"
unset CURRENT_DIR
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-mainline/bin"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/bin/yuzu" "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-mainline/bin"
rm -r "${TEMP_DIR}/pkg-xtract/"*

# Batocera.PLUS do not have this lib required for RPCS3
# 'https://github.com/AlexxandreFS/Batocera.PLUS-pkg/raw/main/rpcs3_extra_libs-1.0.7z'
echo 'Install RPCS3...'
PKG_NAME="$(basename "${URL_RPCS3}")"
chmod +x "${DOWNLOAD_DIR}/${PKG_NAME}"
mkdir -p "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
CURRENT_DIR="$(pwd)"
cd "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
"${CURRENT_DIR}/${DOWNLOAD_DIR}/${PKG_NAME}" --appimage-extract
cd "${CURRENT_DIR}"
unset CURRENT_DIR
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Rpcs3/bin"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/bin/"*  "${TEMP_DIR}/squashfs-root/opt/Rpcs3/bin"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Rpcs3/lib"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/optional/libstdc++/libstdc++."* "${TEMP_DIR}/squashfs-root/opt/Rpcs3/lib"
RPCS3_FILES=(
    libapparmor.so.1
    libasn1.so.8
    libasyncns.so.0
    libcurl.so.4
    libGLEW.so.2.2
    libgssapi.so.3
    libgssapi_krb5.so.2
    libhcrypto.so.4
    libheimbase.so.1
    libheimntlm.so.0
    libhx509.so.5
    libicudata.so.60
    libicui18n.so.60
    libicuuc.so.60
    libidn2.so.0
    libk5crypto.so.3
    libkeyutils.so.1
    libkrb5.so.3
    libkrb5.so.26
    libkrb5support.so.0
    liblber-2.4.so.2
    libldap_r-2.4.so.2
    libnghttp2.so.14
    libnsl.so.1
    libpng16.so.16
    libpsl.so.5
    libpulse.so.0
    libpulsecommon-11.1.so
    libpulse-simple.so.0
    libQt5Core.so.5
    libQt5DBus.so.5
    libQt5Gui.so.5
    libQt5Svg.so.5
    libQt5Widgets.so.5
    libQt5XcbQpa.so.5
    libroken.so.18
    libsasl2.so.2
    libsystemd.so.0
    libtinfo.so.5
    libunistring.so.2
    libwind.so.0
    libwrap.so.0
    libxcb-glx.so.0
    libxcb-icccm.so.4
    libxcb-image.so.0
    libxcb-keysyms.so.1
    libxcb-randr.so.0
    libxcb-render.so.0
    libxcb-render-util.so.0
    libxcb-shape.so.0
    libxcb-shm.so.0
    libxcb-sync.so.1
    libxcb-util.so.1
    libxcb-xfixes.so.0
    libxcb-xinerama.so.0
    libxcb-xinput.so.0
    libxcb-xkb.so.1
)
for FILE in ${RPCS3_FILES[@]}
do
    cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/lib/${FILE}" "${TEMP_DIR}/squashfs-root/opt/Rpcs3/lib"
done
cp -r "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/plugins"      "${TEMP_DIR}/squashfs-root/opt/Rpcs3"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install Yuzu Early Access...'
PKG_NAME="$(basename "${URL_YUZU_EARLY_ACCESS}")"
chmod +x "${DOWNLOAD_DIR}/${PKG_NAME}"
mkdir -p "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
CURRENT_DIR="$(pwd)"
cd "${TEMP_DIR}/pkg-xtract/${PKG_NAME}"
"${CURRENT_DIR}/${DOWNLOAD_DIR}/${PKG_NAME}" --appimage-extract
cd "${CURRENT_DIR}"
unset CURRENT_DIR
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-early-access/bin"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/bin/yuzu"                       "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-early-access/bin"
mkdir -p "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-early-access/lib"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/optional/libstdc++/libstdc++."* "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-early-access/lib"
YUZU_FILES=(
    libboost_context
    libicudata
    libicui18n
    libicuuc
    libQt5Core
    libQt5DBus
    libQt5Gui
    libQt5Widgets
    libQt5XcbQpa
    libxcb-render-util
)
for FILE in ${YUZU_FILES[*]}
do
    cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/lib/${FILE}."* "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-early-access/lib"
done
cp -r "${TEMP_DIR}/pkg-xtract/${PKG_NAME}/squashfs-root/usr/plugins"        "${TEMP_DIR}/squashfs-root/opt/Yuzu/yuzu-early-access"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install Ryujinx...'
PKG_NAME="$(basename "${URL_RYUJINX}")"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c | tar x -v -C "${TEMP_DIR}/pkg-xtract"
rm "${TEMP_DIR}/pkg-xtract/publish/LICENSE-Ryujinx.Audio.txt"
rm "${TEMP_DIR}/pkg-xtract/publish/THIRDPARTY.md"
mv "${TEMP_DIR}/pkg-xtract/publish" "${TEMP_DIR}/squashfs-root/opt/Ryujinx"
ln -sf "${HOME}/logs/ryujinx" "${TEMP_DIR}/squashfs-root/opt/Ryujinx/publish/Logs"

echo 'Install Nvidia Driver...'
PKG_NAME="$(basename "${URL_NVIDIA_DRIVER}")"
chmod +x "${DOWNLOAD_DIR}/${PKG_NAME}"
"${DOWNLOAD_DIR}/${PKG_NAME}" -x --target "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}"
mkdir -p "${TEMP_DIR}/squashfs-root/usr/share/nvidia"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}/nvidia-settings"               "${TEMP_DIR}/squashfs-root/usr/bin"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}/nvidia-application-profiles-"* "${TEMP_DIR}/squashfs-root/usr/share/nvidia"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}/libnvidia-gtk2.so."*           "${TEMP_DIR}/squashfs-root/usr/lib"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}/libnvidia-gtk3.so."*           "${TEMP_DIR}/squashfs-root/usr/lib"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}/libnvidia-encode.so."*         "${TEMP_DIR}/squashfs-root/usr/lib/"
cp "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.run}/libnvcuvid.so."*               "${TEMP_DIR}/squashfs-root/usr/lib/libnvcuvid.so.1"
rm -r "${TEMP_DIR}/pkg-xtract/"*

echo 'Install pci ids database...'
PKG_NAME="$(basename "${URL_PCI_IDS}")"
mkdir -p  "${TEMP_DIR}/squashfs-root/usr/share/hwdata"
cp -f     "${DOWNLOAD_DIR}/${PKG_NAME}"      "${TEMP_DIR}/squashfs-root/usr/share/pci.ids.gz"
gunzip -k "${DOWNLOAD_DIR}/${PKG_NAME}" -c > "${TEMP_DIR}/squashfs-root/usr/share/hwdata/pci.ids"
ln -sf    '/usr/share/hwdata/pci.ids'        "${TEMP_DIR}/squashfs-root/usr/share/pci.ids"

################################################################################

### DROP RAM DISK

sync
umount "${TEMP_DIR}/pkg-xtract/"

################################################################################

### PATCH

echo 'Aplicando Patch...'
cp -f "${TEMP_DIR}/squashfs-root/etc/samba/smb.conf" "${TEMP_DIR}/squashfs-root/etc/samba/smb-ps2smb.conf"
for i in $(du -a "${PATCH_DIR}" | grep -F '.patch' | awk '{print $2}' | sed "s#${PATCH_DIR}/##"); do
    patch -p1 "${TEMP_DIR}/squashfs-root/${i%.patch}" "${PATCH_DIR}/${i}" || exit $?
done

################################################################################

### VERSION FILE

echo 'Criando arquivo de versão do Batocera.PLUS...'
mv   "$TEMP_DIR/squashfs-root/usr/share/batocera/batocera.version" "$TEMP_DIR/squashfs-root/usr/share/batocera/recalbox.version"
echo "$VERSION $(date +'%Y/%m/%d %H:%M')" >                        "$TEMP_DIR/squashfs-root/usr/share/batocera/batocera.version"

echo 'Adicionando versão BATOCERA.PLUS no ES'
sed -i 's/BATOCERA.LINUX/BATOCERA.PLUS /' "${TEMP_DIR}/squashfs-root/usr/bin/emulationstation"

################################################################################

### COMPRESS SQUASHFS

echo 'Compactando arquivo squashfs...'

case ${SQUASHFS_COMPRESSION} in
    1)
        mksquashfs "${TEMP_DIR}/squashfs-root" "${TEMP_DIR}/batocera" || exit $?
        ;;
    2)
        mksquashfs "${TEMP_DIR}/squashfs-root" "${TEMP_DIR}/batocera" -b 512k -comp zstd -Xcompression-level 15 || exit $?
        ;;
    3)
        mksquashfs "${TEMP_DIR}/squashfs-root" "${TEMP_DIR}/batocera" -b 1M -comp xz -Xdict-size 100% || exit $?
        ;;
esac

################################################################################

echo 'Descompactando imagem do BatoceraZero...'
7zr x "${DOWNLOAD_DIR}/${BATOCERA_ZERO}" -o"${TEMP_DIR}"

echo 'Adicionando imagem BatoceraZero ao dispositivo loop...'
losetup -o $((512 * 2048)) /dev/loop6 "$TEMP_DIR/BatoceraZero.img"

echo 'Montando imagem do BatoceraZero...'
mkdir "$TEMP_DIR/BatoceraZero"
mount /dev/loop6 "$TEMP_DIR/BatoceraZero"

echo 'Movendo arquivo compactado squashfs para o BatoceraZero...'
rm "$TEMP_DIR/BATOCERA/boot/batocera"
mv "$TEMP_DIR/batocera" "$TEMP_DIR/BatoceraZero/boot/batocera"

echo 'Copiando arquivos da pasta boot para o BatoceraZero...'
rm    "$TEMP_DIR/BATOCERA/boot/syslinux/ldlinux.sys"
cp -r "$TEMP_DIR/BATOCERA/"* "$TEMP_DIR/BatoceraZero"

echo 'Copiando arquivos extras para o BatoceraZero...'
cp -rf "$BOOT_DIR/"* "$TEMP_DIR/BatoceraZero"

echo 'Copiando programas de windows (tools) para o BatoceraZero...'
PKG_NAME="$(basename "${URL_WINDOWS_TOOLS}")"
unzip  "${DOWNLOAD_DIR}/${PKG_NAME}" -d "${TEMP_DIR}/pkg-xtract" || exit $?
cp -rf "${TEMP_DIR}/pkg-xtract/${PKG_NAME%.*}/"* \
       "${TEMP_DIR}/BatoceraZero/tools" || exit $?
rm -r  "${TEMP_DIR}/pkg-xtract/"*

# Remova a linha à baixo (mv) em uma futura atualização.
mv -f "$TEMP_DIR/linux"      "$TEMP_DIR/BatoceraZero/boot"

################################################################################

### EDIT batocera-boot.conf

echo 'Editando arquivo batocera-boot.conf...'
echo "$(
    while read FILE; do
        echo "${FILE}"
        if [ "$(echo "${FILE}" | grep 'autoresize=')" ]; then
            echo
            echo '# zram size in percent 0=disable (remove the # to enable it)'
            echo 'zram=50'
            echo
            echo '# use swap partition, example: swap.partition=/dev/sda3 (remove the # to enable it)'
            echo 'swap.partition=auto'
            echo
            echo '# create swapfile, 1024=1GB, example: swap.file.size=1024 (remove the # to enable it)'
            echo '#swap.file.size=auto'
            echo
            echo '# enable the splash video on startup /userdata/splashvideo (remove the # to enable video)'
            echo '#splash.video=true'
            echo
            echo '# open a terminal (Win + F4) type xrandr to see all supported resolutions'
            echo '#global.videomode=1280x720'
        fi
    done < "${TEMP_DIR}/BatoceraZero/batocera-boot.conf"
)" > "${TEMP_DIR}/BatoceraZero/batocera-boot.conf"

sed -i 's/^# enable the nvidia driver.*/# enable the nvidia driver (auto, last, 390, 340, false)/' "${TEMP_DIR}/BatoceraZero/batocera-boot.conf"
sed -i 's/^#nvidia-driver=true$/nvidia-driver=auto/'                                               "${TEMP_DIR}/BatoceraZero/batocera-boot.conf"

################################################################################

### UMOUNT ALL IMAGES

sync

echo 'Desmontando imagens...'
umount /dev/loop7
umount /dev/loop6

echo 'Removendo imagens dos disposivos loop...'
losetup -d /dev/loop7
losetup -d /dev/loop6

sync

################################################################################

mv "$TEMP_DIR/BatoceraZero.img" "$TEMP_DIR/Batocera.PLUS.img"

if [ "${RELEASE}" ]; then
    echo 'Copiando arquivos extra para a release...'
    cp -f  "${BOOT_DIR}/batocera-hd-edition/grub.cfg"                "${TEMP_DIR}"                       || exit $?
    cp -f  "${BOOT_DIR}/batocera-hd-edition/leia-me.txt"             "${TEMP_DIR}/dualboot-leia-me.txt"  || exit $?
    #cp -f  "whatsnew.txt"                                            "${TEMP_DIR}"                      || exit $?
    #sed -i "1s/^/#### Batocera.PLUS-${VERSION}-${RELEASE} ####\n\n/" "${TEMP_DIR}/whatsnew.txt"         || exit $?

    echo 'Compactando imagem final...'
    7zr a -mx=9 "${TEMP_DIR}/Batocera.PLUS-${VERSION}-${RELEASE}.7z" "${TEMP_DIR}/Batocera.PLUS.img" || exit $?

    echo 'Gerando Md5sum...'
    md5sum "${TEMP_DIR}/Batocera.PLUS-${VERSION}-${RELEASE}.7z" | cut -d ' ' -f 1 >> "${TEMP_DIR}/md5sum.txt" || exit $?
fi

################################################################################

### CLEAR

echo 'Removendo arquivos temporários...'
rmdir "${TEMP_DIR}/BATOCERA"
rmdir "${TEMP_DIR}/BatoceraZero"
rm -r "${TEMP_DIR}/squashfs-root"
rm    "${TEMP_DIR}/batocera.linux.img"
rmdir "${TEMP_DIR}/pkg-xtract"
if [ "${RELEASE}" ]; then
    rm -r "${TEMP_DIR}/Batocera.PLUS.img"  || exit $?
fi

sync

echo 'IMAGEM CRIADA COM SUCESSO!'

exit 0
